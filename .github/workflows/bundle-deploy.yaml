name: Build and Deploy Extensions to gh-pages

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: HUSKY=0 npm ci

      - name: Clean previous bundles and cache
        run: |
          echo "=== Cleaning previous bundles and build cache ==="
          rm -rf src/bundles
          rm -rf node_modules/.cache
          rm -rf ~/.cache/paperback-cli || true

      - name: Bundle extensions from /src
        run: |
          echo "=== Bundling precompiled extensions from /src ==="
          cd src
          npm run bundle
          cd ..

      - name: Show bundle output
        run: |
          echo "=== Contents of /src/bundles ==="
          if [ -d "src/bundles" ]; then
            ls -R src/bundles
          else
            echo "No bundles found â€” something went wrong with bundling."
          fi

      - name: Add CNAME for GitHub Pages
        run: |
          echo "read.pirate.vodka" > src/bundles/CNAME
          echo "CNAME file written to src/bundles/"

      - name: Deploy to GitHub Pages (root)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: src/bundles
          destination_dir: .
          keep_files: false
          commit_message: "Deploy bundled extensions to gh-pages"